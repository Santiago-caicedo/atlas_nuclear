{% extends "reactores/base.html" %}
{% load static %}

{% block title %}Enciclopedia de Tipos de Reactores{% endblock %}

{% block content %}
<div class="text-center p-5 mb-4 bg-light rounded-3">
    <h1 class="display-4">Enciclopedia de Tipos de Reactores</h1>
    <p class="lead">Selecciona una tecnología para ver un análisis detallado de su despliegue y rendimiento a nivel mundial.</p>
</div>

<div class="row mb-4">
    <div class="col-md-6 offset-md-3">
        <label for="tipo-select" class="form-label fw-bold">Seleccionar Tipo de Reactor:</label>
        <select class="form-select form-select-lg" id="tipo-select">
            <option selected disabled value="">Elige un tipo para analizar...</option>
            {% for tipo in tipos %}
                <option value="{{ tipo }}">{{ tipo }}</option>
            {% endfor %}
        </select>
    </div>
</div>

<div id="results-container" style="display: none;">
    <div class="row" id="kpi-cards">
        </div>

    <div class="row mt-4">
        <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">Rendimiento Promedio Anual (GWh)</div>
                <div class="card-body">
                    <canvas id="rendimientoChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-white">Despliegue de Unidades por Año</div>
                <div class="card-body">
                    <canvas id="despliegueChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h5 class="mb-0">Lista de Reactores de este Tipo</h5>
                </div>
                <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                    <div id="reactor-list-table">
                        </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const tipoSelect = document.getElementById('tipo-select');
    const resultsContainer = document.getElementById('results-container');
    const kpiCardsContainer = document.getElementById('kpi-cards');
    const reactorListTable = document.getElementById('reactor-list-table');
    let rendimientoChart, despliegueChart;

    tipoSelect.addEventListener('change', async function() {
        const selectedTipo = this.value;
        if (!selectedTipo) return;

        // Ocultar resultados y mostrar un estado de carga (opcional)
        resultsContainer.style.display = 'none';
        
        // Llamar a la API para obtener los datos agregados
        const response = await fetch(`/comparador/api/datos-tipo/${encodeURIComponent(selectedTipo)}/`);
        const data = await response.json();
        
        // 1. Llenar Tarjetas de Estadísticas (KPIs)
        const stats = data.estadisticas;
        kpiCardsContainer.innerHTML = `
            <div class="col-md-3 mb-4"><div class="card shadow-sm border-0"><div class="card-body text-center"><h6 class="card-subtitle text-muted">Unidades Totales</h6><p class="display-5 fw-bold">${stats.unidades_totales}</p></div></div></div>
            <div class="col-md-3 mb-4"><div class="card shadow-sm border-0"><div class="card-body text-center"><h6 class="card-subtitle text-muted">Potencia Total (GW)</h6><p class="display-5 fw-bold">${stats.potencia_total_gw}</p></div></div></div>
            <div class="col-md-3 mb-4"><div class="card shadow-sm border-0"><div class="card-body text-center"><h6 class="card-subtitle text-muted">Años de Construcción</h6><p class="display-5 fw-bold">${stats.tiempo_promedio_construccion || 'N/A'}</p></div></div></div>
            <div class="col-md-3 mb-4"><div class="card shadow-sm border-0"><div class="card-body text-center"><h6 class="card-subtitle text-muted">Países Operadores</h6><p class="display-5 fw-bold">${stats.paises_operadores.length}</p></div></div></div>
        `;
        
        // 2. Gráfica de Rendimiento Promedio (Líneas)
        if (rendimientoChart) rendimientoChart.destroy();
        rendimientoChart = new Chart(document.getElementById('rendimientoChart'), {
            type: 'line', 
            data: { 
                labels: data.grafica_rendimiento.map(d => d.ano), 
                datasets: [{ 
                    label: 'Producción Promedio (GWh)', 
                    data: data.grafica_rendimiento.map(d => d.produccion_promedio), 
                    borderColor: '#0d6efd', 
                    tension: 0.1,
                    fill: true,
                    backgroundColor: 'rgba(13, 110, 253, 0.1)'
                }] 
            }
        });

        // 3. Gráfica de Despliegue Anual (Barras)
        if (despliegueChart) despliegueChart.destroy();
        despliegueChart = new Chart(document.getElementById('despliegueChart'), {
            type: 'bar', 
            data: { 
                labels: data.grafica_despliegue.map(d => d.ano_conexion), 
                datasets: [{ 
                    label: 'Unidades Nuevas por Año', 
                    data: data.grafica_despliegue.map(d => d.total), 
                    backgroundColor: '#198754' 
                }] 
            }
        });

        // 4. Llenar Tabla de Reactores
        let tableHtml = '<table class="table table-striped table-hover small"><thead class="table-light"><tr><th>Nombre del Reactor</th><th>País</th><th>Status</th><th>Potencia Neta (MWe)</th></tr></thead><tbody>';
        data.lista_reactores.forEach(r => {
            tableHtml += `<tr><td>${r.nombre}</td><td>${r.pais}</td><td>${r.status}</td><td>${r.potencia_neta || ''}</td></tr>`;
        });
        tableHtml += '</tbody></table>';
        reactorListTable.innerHTML = tableHtml;

        // Mostrar todo el contenedor de resultados con una transición suave
        resultsContainer.style.display = 'block';
    });
});
</script>
{% endblock %}